<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Japanese Kana Learning Game with Shop & Firebase</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #fff9f0;
    margin: 0; padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  h1 {
    color: #3a6bbf;
  }
  #category-select {
    font-size: 1.2rem;
    margin-bottom: 15px;
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid #aaa;
  }
  #score, #timer {
    font-size: 1.2rem;
    margin: 10px 0;
  }
  #timer {
    transition: background-color 0.3s ease;
  }
  #kana {
    font-size: 5rem;
    margin: 25px 0 20px;
  }
  #choices button {
    margin: 0 10px 15px 10px;
    padding: 14px 24px;
    font-size: 1.3rem;
    border-radius: 10px;
    border: 2px solid #3a6bbf;
    cursor: pointer;
    background: white;
    transition: background-color 0.3s, color 0.3s;
  }
  #choices button.correct {
    background-color: #4caf50;
    color: white;
    border-color: #388e3c;
  }
  #choices button.wrong {
    background-color: #f44336;
    color: white;
    border-color: #b33a3a;
  }
  #choices button:disabled {
    cursor: not-allowed;
    opacity: 0.6;
  }
  #feedback {
    height: 1.8rem;
    font-size: 1.2rem;
    color: #555;
    min-height: 24px;
    margin-bottom: 20px;
    font-weight: 600;
  }
  #shop {
    margin-top: 30px;
    width: 320px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    padding: 15px 20px;
    text-align: center;
  }
  #shop h2 {
    color: #3a6bbf;
    margin-top: 0;
  }
  #shop button {
    margin-top: 10px;
    padding: 10px 20px;
    font-size: 1.1rem;
    cursor: pointer;
    border-radius: 6px;
    background-color: #3a6bbf;
    color: white;
    border: none;
    transition: background-color 0.3s;
  }
  #shop button:disabled {
    background-color: #aaa;
    cursor: not-allowed;
  }
  #leaderboard {
    margin-top: 30px;
    width: 320px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    padding: 15px 20px;
  }
  #leaderboard h2 {
    color: #3a6bbf;
    margin-top: 0;
    margin-bottom: 12px;
  }
  #leaderboard-list {
    list-style: none;
    padding-left: 0;
    margin: 0;
  }
  #leaderboard-list li {
    margin-bottom: 6px;
  }
</style>
</head>
<body>
  <div id="navbar"></div>
<script>
  fetch("navbar.html")
    .then(res => res.text())
    .then(html => {
      document.getElementById("navbar").innerHTML = html;
    });
</script>

<h1>Learn Japanese Kana</h1>

<select id="category-select" aria-label="Select Kana Category">
  <option value="hiragana-a">Hiragana: A-row (あ, い, う, え, お)</option>
  <option value="hiragana-ka">Hiragana: Ka-row (か, き, く, け, こ)</option>
  <option value="hiragana-sa">Hiragana: Sa-row (さ, し, す, せ, そ)</option>
  <option value="hiragana-ta">Hiragana: Ta-row (た, ち, つ, て, と)</option>
  <option value="hiragana-na">Hiragana: Na-row (な, に, ぬ, ね, の)</option>
  <option value="hiragana-ha">Hiragana: Ha-row (は, ひ, ふ, へ, ほ)</option>
  <option value="hiragana-ma">Hiragana: Ma-row (ま, み, む, め, も)</option>
  <option value="hiragana-ya">Hiragana: Ya-row (や, ゆ, よ)</option>
  <option value="hiragana-ra">Hiragana: Ra-row (ら, り, る, れ, ろ)</option>
  <option value="hiragana-wa">Hiragana: Wa-row (わ, を)</option>
  <option value="katakana-a">Katakana: A-row (ア, イ, ウ, エ, オ)</option>
  <option value="katakana-ka">Katakana: Ka-row (カ, キ, ク, ケ, コ)</option>
</select>


<div id="score">Score: 0</div>
<div id="timer">Time left: 10s</div>

<div id="kana" aria-live="polite" aria-atomic="true">あ</div>

<div id="choices" role="list"></div>
<div id="feedback" role="alert" aria-live="assertive"></div>

<div id="shop">
  <h2>Item Shop</h2>
  <p>Buy a hint to get the correct answer:</p>
  <button id="buy-hint-btn" aria-label="Buy Hint for 20 points">Buy Hint (cost: 20 points)</button>
</div>

<div id="leaderboard" aria-label="Leaderboard">
  <h2>Leaderboard (Firestore)</h2>
  <ul id="leaderboard-list"></ul>
</div>

<!-- Sounds -->
<audio id="correct-sound" src="audio/correct.mp3" preload="auto"></audio>
<audio id="wrong-sound" src="audio/wrong.mp3" preload="auto"></audio>
<audio id="timeout-sound" src="audio/warning.mp3" preload="auto"></audio>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  // Your Firebase config — replace with your own values!
  const firebaseConfig = {
      apiKey: "AIzaSyDaAyuSvzzk80iH8ydOTWBRhjkpsIZpYRI",
      authDomain: "hiragana-trainer.firebaseapp.com",
      projectId: "hiragana-trainer",
      storageBucket: "hiragana-trainer.appspot.com",
      messagingSenderId: "1061396749731",
      appId: "1:1061396749731:web:e3e349d735b9401a4ece16",
      measurementId: "G-BQGGQDPP9T"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // Kana data by categories
  const kanaCategories = {
  "hiragana-a": [
    { kana: "あ", romaji: "a" },
    { kana: "い", romaji: "i" },
    { kana: "う", romaji: "u" },
    { kana: "え", romaji: "e" },
    { kana: "お", romaji: "o" }
  ],
  "hiragana-ka": [
    { kana: "か", romaji: "ka" },
    { kana: "き", romaji: "ki" },
    { kana: "く", romaji: "ku" },
    { kana: "け", romaji: "ke" },
    { kana: "こ", romaji: "ko" }
  ],
  "hiragana-sa": [
    { kana: "さ", romaji: "sa" },
    { kana: "し", romaji: "shi" },
    { kana: "す", romaji: "su" },
    { kana: "せ", romaji: "se" },
    { kana: "そ", romaji: "so" }
  ],
  "hiragana-ta": [
    { kana: "た", romaji: "ta" },
    { kana: "ち", romaji: "chi" },
    { kana: "つ", romaji: "tsu" },
    { kana: "て", romaji: "te" },
    { kana: "と", romaji: "to" }
  ],
  "hiragana-na": [
    { kana: "な", romaji: "na" },
    { kana: "に", romaji: "ni" },
    { kana: "ぬ", romaji: "nu" },
    { kana: "ね", romaji: "ne" },
    { kana: "の", romaji: "no" }
  ],
  "hiragana-ha": [
    { kana: "は", romaji: "ha" },
    { kana: "ひ", romaji: "hi" },
    { kana: "ふ", romaji: "fu" },
    { kana: "へ", romaji: "he" },
    { kana: "ほ", romaji: "ho" }
  ],
  "hiragana-ma": [
    { kana: "ま", romaji: "ma" },
    { kana: "み", romaji: "mi" },
    { kana: "む", romaji: "mu" },
    { kana: "め", romaji: "me" },
    { kana: "も", romaji: "mo" }
  ],
  "hiragana-ya": [
    { kana: "や", romaji: "ya" },
    { kana: "", romaji: "" },
    { kana: "ゆ", romaji: "yu" },
    { kana: "", romaji: "" },
    { kana: "よ", romaji: "yo" }
  ],
  "hiragana-ra": [
    { kana: "ら", romaji: "ra" },
    { kana: "り", romaji: "ri" },
    { kana: "る", romaji: "ru" },
    { kana: "れ", romaji: "re" },
    { kana: "ろ", romaji: "ro" }
  ],
  "hiragana-wa": [
    { kana: "わ", romaji: "wa" },
    { kana: "", romaji: "" },
    { kana: "", romaji: "" },
    { kana: "", romaji: "" },
    { kana: "を", romaji: "wo" }
  ],
  "katakana-a": [
    { kana: "ア", romaji: "a" },
    { kana: "イ", romaji: "i" },
    { kana: "ウ", romaji: "u" },
    { kana: "エ", romaji: "e" },
    { kana: "オ", romaji: "o" }
  ],
  "katakana-ka": [
    { kana: "カ", romaji: "ka" },
    { kana: "キ", romaji: "ki" },
    { kana: "ク", romaji: "ku" },
    { kana: "ケ", romaji: "ke" },
    { kana: "コ", romaji: "ko" }
  ],
    "katakana-ka": [
      { kana: "カ", romaji: "ka" },
      { kana: "キ", romaji: "ki" },
      { kana: "ク", romaji: "ku" },
      { kana: "ケ", romaji: "ke" },
      { kana: "コ", romaji: "ko" }
    ]
  };

  // State variables
  let score = 0;
  let timerSeconds = 10;
  let timerInterval = null;
  const maxTimer = 10;
  let currentCorrectAnswer = "";
  let userId = null;

  // DOM elements
  const scoreDiv = document.getElementById("score");
  const timerDiv = document.getElementById("timer");
  const kanaDiv = document.getElementById("kana");
  const choicesDiv = document.getElementById("choices");
  const leaderboardList = document.getElementById("leaderboard-list");
  const feedbackDiv = document.getElementById("feedback");
  const categorySelect = document.getElementById("category-select");
  const buyHintBtn = document.getElementById("buy-hint-btn");

  const correctSound = document.getElementById("correct-sound");
  const wrongSound = document.getElementById("wrong-sound");
  const timeoutSound = document.getElementById("timeout-sound");

  // Simple shuffle helper
  function shuffle(arr) {
    for(let i = arr.length - 1; i > 0; i--){
      const j = Math.floor(Math.random() * (i+1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  // Update score display and leaderboard
  function updateScore(points) {
    score += points;
    if(score < 0) score = 0;
    scoreDiv.textContent = "Score: " + score;
    updateLeaderboard(score);
    updateBuyHintButton();
  }

  // Enable or disable shop button based on points
  function updateBuyHintButton(){
    buyHintBtn.disabled = score < 20;
  }

  // Timer UI update with flash color effect
  function updateTimerDisplay() {
    timerDiv.textContent = `Time left: ${timerSeconds}s`;
    timerDiv.style.color = timerSeconds <= 3 ? '#b33a3a' : 'black';
    if(timerSeconds <= 3) {
      timerDiv.style.backgroundColor = timerDiv.style.backgroundColor === "transparent" ? "#f8d7da" : "transparent";
      setTimeout(() => {
        timerDiv.style.backgroundColor = "transparent";
      }, 300);
    }
  }

  // Timer start/reset
  function startTimer() {
    timerSeconds = maxTimer;
    updateTimerDisplay();
    timerInterval = setInterval(() => {
      timerSeconds--;
      updateTimerDisplay();
      if(timerSeconds <= 0){
        clearInterval(timerInterval);
        feedbackDiv.textContent = "Time's up! -5 points";
        playSound(timeoutSound);
        updateScore(-5);
        disableChoices();
        setTimeout(() => {
          feedbackDiv.textContent = "";
          newRound();
        }, 1500);
      }
    }, 1000);
  }

  // Play sound helper
  function playSound(sound) {
    if(sound){
      sound.pause();
      sound.currentTime = 0;
      sound.play();
    }
  }

  // Disable all choices buttons after answer or time out
  function disableChoices() {
    Array.from(choicesDiv.children).forEach(b => b.disabled = true);
  }

  // Start a new round of the game
  function newRound() {
    feedbackDiv.textContent = "";
    clearInterval(timerInterval);
    startTimer();

    const category = categorySelect.value;
    const kanaList = kanaCategories[category];

    if (!kanaList || kanaList.length === 0) {
      kanaDiv.textContent = "No kana!";
      choicesDiv.innerHTML = "";
      return;
    }

    // Pick correct kana randomly
    const correctEntry = kanaList[Math.floor(Math.random() * kanaList.length)];
    currentCorrectAnswer = correctEntry.romaji;
    kanaDiv.textContent = correctEntry.kana;

    // Pick two wrong options
    let wrongOptions = [];
    while(wrongOptions.length < 2){
      const candidate = kanaList[Math.floor(Math.random() * kanaList.length)].romaji;
      if(candidate !== correctEntry.romaji && !wrongOptions.includes(candidate)){
        wrongOptions.push(candidate);
      }
    }

    // Shuffle answers
    const options = shuffle([correctEntry.romaji, ...wrongOptions]);

    // Create buttons
    choicesDiv.innerHTML = '';

    options.forEach(option => {
      const btn = document.createElement('button');
      btn.textContent = option;
      btn.setAttribute("role", "listitem");
      btn.onclick = () => {
        clearInterval(timerInterval);
        disableChoices();
        if(option === correctEntry.romaji){
          btn.classList.add("correct");
          feedbackDiv.textContent = "Correct! +10 points";
          playSound(correctSound);
          updateScore(10);
        } else {
          btn.classList.add("wrong");
          feedbackDiv.textContent = `Wrong! Correct: ${correctEntry.romaji} -5 points`;
          playSound(wrongSound);
          updateScore(-5);
        }
        setTimeout(() => {
          feedbackDiv.textContent = "";
          newRound();
        }, 1500);
      };
      choicesDiv.appendChild(btn);
    });
  }

  // Buy a hint: Reveal correct answer but costs points
  buyHintBtn.onclick = () => {
    if(score >= 20){
      updateScore(-20);
      feedbackDiv.textContent = `Hint: The correct answer is "${currentCorrectAnswer}"`;
    }
  };

  // Firebase auth and leaderboard logic
  async function signInAnonymously() {
    try {
      const userCredential = await auth.signInAnonymously();
      userId = userCredential.user.uid;
      loadLeaderboard();
    } catch (error) {
      console.error("Authentication error:", error);
      alert("Firebase Authentication failed. Please check your config.");
    }
  }

  // Update user's score in Firestore
  async function updateLeaderboard(newScore) {
    if(!userId) return;
    const userDoc = db.collection('leaderboard').doc(userId);
    try {
      await userDoc.set({ score: newScore }, { merge: true });
      loadLeaderboard();
    } catch (error) {
      console.error("Error updating leaderboard:", error);
    }
  }

  // Load leaderboard top 10 users from Firestore
  async function loadLeaderboard() {
    try {
      const querySnapshot = await db.collection('leaderboard')
        .orderBy('score', 'desc')
        .limit(10)
        .get();

      leaderboardList.innerHTML = "";
      querySnapshot.forEach(doc => {
        const li = document.createElement('li');
        li.textContent = `User: ${doc.id.substring(0,6)} — Score: ${doc.data().score}`;
        leaderboardList.appendChild(li);
      });
    } catch (error) {
      console.error("Error loading leaderboard:", error);
    }
  }

  // Initialize game on load
  window.onload = () => {
    signInAnonymously();
    updateBuyHintButton();
    newRound();
  };

  // Restart round on category change
  categorySelect.addEventListener("change", () => {
    clearInterval(timerInterval);
    feedbackDiv.textContent = "";
    newRound();
  });

</script>

</body>
</html>
